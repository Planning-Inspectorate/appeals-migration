generator client {
  provider = "prisma-client"
  output   = "./client"

  engineType = "client"
  runtime    = "nodejs"
}

datasource db {
  provider = "sqlserver"
}

// NOTES
//
// use '//' comments for notes relevant to the schema
// use '///' comments for notes that should be included in the types definition
// see https://www.prisma.io/docs/concepts/components/prisma-schema#comments

/// A table to hold migration parameter configuration
/// each entry would equate to one case search, and will map to CaseSearchCriteria in case-search.ts
model ToMigrateParameter {
  id Int @id

  caseTypeName     String?
  dateReceivedFrom DateTime?
  dateReceivedTo   DateTime?
  decisionDateFrom DateTime?
  decisionDateTo   DateTime?
  lpa              String?
  procedureType    String?
  startDateFrom    DateTime?
  startDateTo      DateTime?
  status           String?
}

model CaseToMigrate {
  caseReference String @id

  // migration steps tracked per case

  dataStepId Int           @unique
  DataStep   MigrationStep @relation("DataStep", fields: [dataStepId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  documentListStepId Int           @unique
  DocumentListStep   MigrationStep @relation("DocumentListStep", fields: [documentListStepId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  documentsStepId Int           @unique
  DocumentsStep   MigrationStep @relation("DocumentsStep", fields: [documentsStepId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  validationStepId Int           @unique
  ValidationStep   MigrationStep @relation("ValidationStep", fields: [validationStepId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  // validation outcome
  dataValidated      Boolean?
  documentsValidated Boolean?
}

model MigrationStep {
  id Int @id @default(autoincrement())

  /// status of this step: waiting | queued | processing | complete | failed
  status       String    @default("waiting")
  errorMessage String?
  invocationId String?
  startedAt    DateTime?
  completedAt  DateTime?

  DataStepCase         CaseToMigrate?     @relation("DataStep")
  DocumentListStepCase CaseToMigrate?     @relation("DocumentListStep")
  DocumentsStepCase    CaseToMigrate?     @relation("DocumentsStep")
  ValidationStepCase   CaseToMigrate?     @relation("ValidationStep")
  DocumentToMigrate    DocumentToMigrate?
}

/// A table to hold documents that need to be migrated for each case
model DocumentToMigrate {
  documentId String @id

  caseReference String

  migrationStepId Int           @unique
  MigrationStep   MigrationStep @relation(fields: [migrationStepId], references: [id], onUpdate: NoAction, onDelete: NoAction)
}
